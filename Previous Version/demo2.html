<html>
    <head>
        <title>CG - Babylon</title>
        <script src="https://preview.babylonjs.com/babylon.js"></script>
        <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
        <script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>
        <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
        <style>
          html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
          }
          #render {
            width: 100%;
            height: 100%;
            touch-action: none;
          }
        </style>
    <body>
        <canvas id="render" touch-action="none">
        <script>
            var canvas = document.getElementById("render");
            var engine = new BABYLON.Engine(canvas, true);
            var createScene = function() {
                var scene = new BABYLON.Scene(engine);
                    // street
                    var multiplier = 17;
                    //var lightmap = new BABYLON.Texture("Import/candleopacity.png", scene);
                    //var groundMaterial = new BABYLON.StandardMaterial("groundMaterial", scene);
                    //groundMaterial.lightmapTexture = lightmap;
                    //multiplier.material = groundMaterial;
                    //multiplier.receiveShadows = true;

                    //button
                    var lightSphere0 = BABYLON.Mesh.CreateSphere("Sphere0", 16, 0.5, scene);
                    lightSphere0.position = new BABYLON.Vector3(-22.6, 5.5, 12.4);
                    lightSphere0.material = new BABYLON.StandardMaterial("red", scene);
                    lightSphere0.material.diffuseColor = new BABYLON.Color3(0, 0, 0);
                    lightSphere0.material.specularColor = new BABYLON.Color3(0, 0, 0);
                    lightSphere0.material.emissiveColor = new BABYLON.Color3(1, 0, 0);


                    // light
                    var light = new BABYLON.SpotLight("spot", new BABYLON.Vector3(-30, 6, -14), new BABYLON.Vector3(0, -1, 0), 4, 2, scene);
                    light.intensity = 0.8;
                    light.diffuse = new BABYLON.Color3(1, 1, 1);
                    light.specular = new BABYLON.Color3(0, 0, 0);
                    var light3 = new BABYLON.SpotLight("spt1", new BABYLON.Vector3(25, 6, 27), new BABYLON.Vector3(0, -1, 0), 6, 2, scene);
                    light3.diffuse = new BABYLON.Color3(1, 1, 1);
                    light3.specular = new BABYLON.Color3(0, 0, 0);
                    var light4 = new BABYLON.SpotLight("spt2", new BABYLON.Vector3(-22, 10, 27), new BABYLON.Vector3(0, -1, 0), 6, 2, scene);
                    light4.diffuse = new BABYLON.Color3(1, 1, 1);
                    light4.specular = new BABYLON.Color3(0, 0, 0);
                    var light2 = new BABYLON.PointLight("light2", new BABYLON.Vector3(38, 5.7, -38), scene);
                    light2.intensity = 0.4;
                    var light0 = new BABYLON.SpotLight("Spot0", new BABYLON.Vector3(28, 5, -15), new BABYLON.Vector3(0, -1, 0), 3, 2, scene);
                    light0.diffuse = new BABYLON.Color3(1, 1, 1);
                    light0.specular = new BABYLON.Color3(0, 0, 0);
                    // camera
                    var camera = new BABYLON.FlyCamera("Camera", new BABYLON.Vector3(0, 5.569, 0), scene); // AWSD
                    //var camera = new BABYLON.ArcRotateCamera("Camera", 0, Math.PI / 2, 10, new BABYLON.Vector3.Zero(), scene);
                    camera.attachControl(canvas, true);
                    camera.maxCameraSpeed =  0.4;
                    camera.speed = .35;
                    camera.rollCorrect = 10;
                    // gravity
                    scene.gravity = new BABYLON.Vector3(0, -9.81, 0);
                    camera.applyGravity = true;
                    camera.ellipsoid = new BABYLON.Vector3(1, 7, 1);
                    scene.collisionsEnabled = true;
                    camera.checkCollisions = true;
                    scene.checkCollisions = true;
                    //pointererase
                    canvas.requestPointerLock()
                    document.exitPointerLock = document.exitPointerLock;
                    canvas.onclick = function() {
                    canvas.requestPointerLock();
                    }
                    var floor = BABYLON.MeshBuilder.CreateGround("street", {width: 5*multiplier, height: 5*multiplier, subdivisions: 4}, scene);

                    floor.position.x = 0;
                    floor.position.y = -multiplier/2;
                    floor.color = new BABYLON.Color3(1,1,1);
                    // collision house and street
                    floor.checkCollisions = true;
                    floor.receiveShadows = true;



                    //wall a
                    function makeWall(width, height, size, x, z, rotationy)
                    {
                        var wall = BABYLON.MeshBuilder.CreateBox("box", {width: width*multiplier, height: height*multiplier,size: size}, scene);
                        wall.position.x = x*multiplier;
                        wall.position.z = z*multiplier;
                        wall.rotation.y = rotationy;
                        wall.color = new BABYLON.Color3(0,0,0);
                        wall.checkCollisions = true;
                        return wall;
                    };
                    function makeborder(width, height, size, x, y, z, rotationy)
                    {
                        var wall = BABYLON.MeshBuilder.CreateBox("box", {width: width*multiplier, height: height*multiplier,size: size}, scene);
                        wall.position.x = x*multiplier;
                        wall.position.z = z*multiplier;
                        wall.position.y = y*multiplier;
                        wall.rotation.y = rotationy;
                        wall.color = new BABYLON.Color3(0,0,0);
                        wall.checkCollisions = true;
                    };
                    walla = makeWall(5, 1.5,1, 0,-2.5, 0); //walla
                    wallb =makeWall(5.055, 1.5, 1,-2.5,0, Math.PI/2);//wallb
                    wallc =makeWall(5.055, 1.5, 1,2.5,0, Math.PI/2);//wallc
                    walld =makeWall(5, 1.5, 1,0, 2.5, 0);//walld
                    walle =makeWall(3, 1.5, 1,.75,1, Math.PI/2);//walle
                    wallf =makeWall(1.25, 1.5, 1,.75,-1.875, Math.PI/2);//wallf
                    wallg =makeWall(1.5, 1.5, 1,-1.75,.75, 0);//wallg
                    wallh =makeWall(.5, 1.5, 1,2.25,.75, 0);//wallh
                    walli =makeWall(1.25, 1.5, 1,.75,-1.875, Math.PI/2);//walli
                    wallk =makeWall(.75, 1.5, 1, 1.15, .75, 0);//wallk
                    makeborder(.48, .155, 1, 1.765, .675,.75, 0);//bordera
                    makeborder(.75, .15, 1, .75, .675,-.875, Math.PI/2);//borderb
                    // roof = makeWall(5, 5, 1, 0, 0, 0, 0)
                    // roof.rotation.x = Math.PI/2;
                    // roof.position.y = .785* multiplier;

                    function meshSetup(newMeshes, x, z, rotation, scale, light){
                      // var shadowGenerator = new BABYLON.ShadowGenerator(1024, light);
                      // shadowGenerator.useBlurExponentialShadowMap = true;
                      // shadowGenerator.useKernelBlur = true;
                      // shadowGenerator.blurKernel = 64;
                      // shadowGenerator.forceBackFacesOnly = true;
                      // shadowGenerator.getShadowMap().refreshRate = BABYLON.RenderTargetTexture.REFRESHRATE_RENDER_ONCE;
                        for (i = 0; i < newMeshes.length; i++)
                        {
                        setup(newMeshes[i]);
                        var mesh = newMeshes[i];
                        object = mesh;
                        console.log(newMeshes.length);
                        //newMeshes[i].isPickable = true;
                        object.checkCollisions = true;

                        // shadowGenerator.getShadowMap().renderList.push(newMeshes[i]);
                        // newMeshes[i].receiveShadows = true;
                        //put scaling and position inside function below
                        function setup(mesh) {mesh.rotation.y = rotation; mesh.position = new BABYLON.Vector3(x*multiplier, floor.position.y, z*multiplier); mesh.scaling = new BABYLON.Vector3(scale*multiplier, scale*multiplier, scale*multiplier); }
                        }
                        linkMesh(object);
                    }
                    BABYLON.SceneLoader.ImportMesh("", "Import/LivingRoom/Table/", "table.obj", scene, function(newMeshes) {
                          //table
                          meshSetup(newMeshes, -1.75, -.75, 0, .1, light);
                    });
                    BABYLON.SceneLoader.ImportMesh("", "Import/Bedroom/Desk/", "table2.obj", scene, function(newMeshes) {
                          //desk
                          meshSetup(newMeshes, 1.15, 0.275, Math.PI/2, .6, light);
                    });
                    BABYLON.SceneLoader.ImportMesh("", "Import/DiningRoom/Kitchen2/", "kitchen.obj", scene, function(newMeshes) {
                          //kitchen
                          meshSetup(newMeshes, -2.25, 1.5, Math.PI/2, .05, light);
                    });
                    BABYLON.SceneLoader.ImportMesh("", "Import/LivingRoom/Sofa2/", "atelier-pfister-riom-sofa.obj", scene, function(newMeshes) {
                          // sofa_model
                          meshSetup(newMeshes, -.75, -1.5, -Math.PI/2, .05, light);
                    });
                    BABYLON.SceneLoader.ImportMesh("", "Import/Bedroom/Bed/", "arc-double-bed-light-2.obj", scene, function(newMeshes) {
                          // bed
                          meshSetup(newMeshes, 1.65, -1.75, 0, .5, light);
                    });
                    BABYLON.SceneLoader.ImportMesh("", "Import/Bedroom/Lamp/", "lampa.obj", scene, function(newMeshes) {
                          //Lamp
                          meshSetup(newMeshes, 2.25, -2, 0, .5,  light);
                    });
                    BABYLON.SceneLoader.ImportMesh("", "Import/Bathroom/Toilet/", "toilet-water-closet.obj", scene, function(newMeshes) {
                          //toilet
                          meshSetup(newMeshes, 1, 1.25, Math.PI/2, .0125, light0);
                    });
                    BABYLON.SceneLoader.ImportMesh("", "Import/Bathroom/Sink/", "bathroom-2.obj", scene, function(newMeshes) {
                          //sink
                          meshSetup(newMeshes, 1, 2, Math.PI/2, 50, light0);
                    });
                     BABYLON.SceneLoader.ImportMesh("", "Import/DiningRoom/DiningTable/", "table-and-chairs.obj", scene, function(newMeshes) {
                          // diningtable
                          meshSetup(newMeshes, -.25, 1.5, 0, .5, light);
                    });
                    BABYLON.SceneLoader.ImportMesh("", "Import/Bathroom/Bath/", "bath_obj.obj", scene, function(newMeshes) {
                          // tub
                          meshSetup(newMeshes, 2.2, 1.85, Math.PI/2, .025, light0);
                    });
                      var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
                      function text(desc, color, size, font, weight, left, top){
                        var words= new BABYLON.GUI.TextBlock();
                            words.text = desc;
                            words.color = color;
                            words.fontSize = size;
                            words.fontFamily = font;
                            words.fontWeight = weight;
                            words.left = left;
                            words.top	 = top;
                        advancedTexture.addControl(words);


                      };
                      function updateText(text, desc)
                      {
                        text.text =desc;
                      }
                      var rect1 = new BABYLON.GUI.Rectangle();
                          rect1.width = 0.2;
                          rect1.height = "100px";
                          rect1.cornerRadius = 10;
                          rect1.color = "black";
                          rect1.thickness = 0;
                          rect1.background = "black";
                          rect1.alpha = .5;
                          rect1.left = "-700px";
                          rect1.top	 = "-290px";
                          advancedTexture.addControl(rect1);
                    var objectives = "- Make Breakfast"
                    text("Objectives:", "white", 24, "Times", "bold", "-700px","-300px");
                    text(objectives, "white", 20, "Times", "", "-680px","-270px");
                    var map = {}; //object for multiple key presses


                    scene.actionManager = new BABYLON.ActionManager(scene);
                    scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, function (evt) {
                        map[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
                    }));
                    scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, function (evt) {
                        map[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
                    }));
                    function linkMesh(mesh) {
                          var rect1 = new BABYLON.GUI.Rectangle();
                          rect1.width = 0.15;
                          rect1.height = "40px";
                          rect1.color = "white";
                          rect1.thickness = 4;
                          rect1.background = "transparent";
                          advancedTexture.addControl(rect1);
                          rect1.linkOffsetY = -150;
                          rect1.top += 2;

                          var label = new BABYLON.GUI.TextBlock();
                          label.text = "E";
                          rect1.addControl(label);

                          var target = new BABYLON.GUI.Ellipse();
                          target.width = "40px";
                          target.height = "40px";
                          target.color = "white";
                          target.thickness = 4;
                          target.background = "transparent";
                          advancedTexture.addControl(target);
                          target.top += 2;

                          var line = new BABYLON.GUI.Line();
                          line.lineWidth = 4;
                          line.color = "whites";
                          line.y2 = 20;
                          line.linkOffsetY = -20;
                          advancedTexture.addControl(line);
                          line.connectedControl = rect1;
                          line.top += 2;

                          rect1.linkWithMesh(mesh);
                          target.linkWithMesh(mesh);
                          line.linkWithMesh(mesh);
                          scene.registerAfterRender(function() {
                            if (BABYLON.Vector3.Distance(camera.position,mesh.position)<20){
                              rect1.isVisible = true;
                              target.isVisible = true;
                              line.isVisible = true;
                            };
                            if ((map["e"]) || (map["E"]) && mesh.name =="bath_max" && BABYLON.Vector3.Distance(camera.position,mesh.position)<20) {
                                //console.log(mesh.name);
                                rect1.isVisible = false;
                                target.isVisible = false;
                                line.isVisible = false;
                                label.text = "E";
                            };

                            if (BABYLON.Vector3.Distance(camera.position,mesh.position)>30){
                              rect1.isVisible = false;
                              target.isVisible = false;
                              line.isVisible = false;
                            };
                          });
                  	};


                    scene.registerBeforeRender(function () {
                        var objectives = "-Make Be ";
                        //console.log(camera.position);
                        if ((map["Shift"])) {
                            camera.maxCameraSpeed =  .75;
                            camera.speed = .65;
                            }
                        else{
                          camera.maxCameraSpeed =  0.3;
                          camera.speed = .25;
                        };
                        //if(BABYLON.Vector3.Distance(camera.position,.position) <5){

                        if ((map["e"]) || (map["E"])) {
                            //scene.meshes[11].dispose();
                        };

                    });

            return scene;
            }
            var scene = createScene();
            engine.runRenderLoop(function() {
            scene.render();
            });
            window.addEventListener("size", function() {
            engine.size();
            });
        </script>
    </body>
</html>
